<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Hídrico (2022) - Dashboard Admin</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
          --primary-color: #0d3b66;
          --secondary-color: #144b82;
          --alert-color: #e74c3c;
          --warning-color: #f39c12;
          --attention-color: #f1c40f;
          --normal-color: #2ecc71;
          --emergency-color: #9b59b6;
          --background-color: #f5f7fa;
          --text-color: #333;
          --light-text: #fff;
          --card-shadow: 0 2px 6px rgba(0,0,0,0.1);
          --card-radius: 12px;
        }

        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }

        body {
          margin: 0;
          font-family: 'Segoe UI', Arial, sans-serif;
          background: var(--background-color);
          color: var(--text-color);
          line-height: 1.6;
        }

        .container {
          display: flex;
          height: 100vh;
        }

        /* Sidebar */
        .sidebar {
          width: 250px;
          background: var(--primary-color);
          color: var(--light-text);
          display: flex;
          flex-direction: column;
          padding: 20px 0;
          box-shadow: 2px 0 10px rgba(0,0,0,0.1);
          z-index: 100;
        }

        .logo {
          font-size: 22px;
          font-weight: bold;
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 0 20px;
          margin-bottom: 30px;
        }

        .logo i {
          font-size: 26px;
        }

        .menu {
          flex: 1;
        }

        .menu a {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 14px 20px;
          text-decoration: none;
          color: var(--light-text);
          transition: all 0.3s;
          border-left: 4px solid transparent;
        }

        .menu a:hover, .menu a.active {
          background: var(--secondary-color);
          border-left-color: var(--light-text);
        }

        .menu a i {
          width: 20px;
          text-align: center;
        }

        /* Main */
        .main {
          flex: 1;
          padding: 20px;
          overflow-y: auto;
          background: #f0f2f5;
        }

        .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: var(--light-text);
          color: var(--primary-color);
          padding: 15px 25px;
          border-radius: var(--card-radius);
          margin-bottom: 20px;
          box-shadow: var(--card-shadow);
        }

        .header h1 {
          font-size: 24px;
          font-weight: 600;
        }

        .user-menu {
          position: relative;
          display: inline-block;
        }

        .user-menu-btn {
          background: none;
          border: none;
          color: var(--primary-color);
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 16px;
          padding: 8px 12px;
          border-radius: 6px;
          transition: background 0.3s;
        }

        .user-menu-btn:hover {
          background: #f0f2f5;
        }

        .dropdown {
          position: absolute;
          right: 0;
          top: 100%;
          background: var(--light-text);
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 8px;
          box-shadow: 0 10px 20px rgba(0,0,0,.08);
          z-index: 1000;
          min-width: 180px;
        }

        .dropdown.hidden {
          display: none;
        }

        .dropdown a {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 10px 12px;
          color: var(--text-color);
          text-decoration: none;
          border-radius: 4px;
        }

        .dropdown a:hover {
          background: #f3f4f6;
        }

        /* Sections */
        .section {
          display: none;
        }

        .section.active {
          display: block;
        }

        /* Dashboard Grid */
        .dashboard-grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 20px;
          margin-bottom: 20px;
        }

        .stat-card {
          background: var(--light-text);
          border-radius: var(--card-radius);
          padding: 20px;
          box-shadow: var(--card-shadow);
          display: flex;
          align-items: center;
          gap: 15px;
          transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .stat-icon {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 24px;
          color: white;
        }

        .stat-icon.normal { background-color: var(--normal-color); }
        .stat-icon.atencao { background-color: var(--attention-color); }
        .stat-icon.alerta { background-color: var(--warning-color); }
        .stat-icon.emergencia { background-color: var(--alert-color); }

        .stat-info h3 {
          font-size: 28px;
          margin-bottom: 5px;
        }

        .stat-info p {
          color: #666;
          font-size: 14px;
        }

        /* Content Grid */
        .content-grid {
          display: grid;
          grid-template-columns: 2fr 1fr;
          gap: 20px;
          margin-bottom: 20px;
        }

        /* Map */
        .map-container {
          background: var(--light-text);
          border-radius: var(--card-radius);
          padding: 20px;
          box-shadow: var(--card-shadow);
          height: 420px;
          grid-column: 1;
        }

        .map-container h3 {
          margin: 0 0 15px;
          font-size: 18px;
          color: var(--primary-color);
        }

        #map {
          height: 350px;
          border-radius: 8px;
        }

        /* Alert Feed */
        .alert-feed {
          background: var(--light-text);
          border-radius: var(--card-radius);
          padding: 20px;
          box-shadow: var(--card-shadow);
          height: 420px;
          display: flex;
          flex-direction: column;
          grid-column: 2;
        }

        .alert-feed h3 {
          margin: 0 0 15px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 18px;
          color: var(--primary-color);
        }

        .alert-filters {
          display: flex;
          gap: 10px;
        }

        .alert-filters select, .alert-filters button {
          padding: 8px 12px;
          border-radius: 6px;
          border: 1px solid #ddd;
          font-size: 14px;
        }

        .alert-list {
          flex: 1;
          overflow-y: auto;
          border: 1px solid #eee;
          border-radius: 8px;
          padding: 10px;
        }

        .alert-item {
          padding: 12px;
          border-bottom: 1px solid #eee;
          display: flex;
          align-items: center;
          gap: 12px;
          transition: background 0.2s;
        }

        .alert-item:hover {
          background: #f9f9f9;
        }

        .alert-item:last-child {
          border-bottom: none;
        }

        .alert-icon {
          width: 12px;
          height: 12px;
          border-radius: 50%;
          flex-shrink: 0;
        }

        .alert-icon.normal {
          background-color: var(--normal-color);
        }

        .alert-icon.atencao {
          background-color: var(--attention-color);
        }

        .alert-icon.alerta {
          background-color: var(--warning-color);
        }

        .alert-icon.emergencia {
          background-color: var(--alert-color);
        }

        .alert-content {
          flex: 1;
        }

        .alert-time {
          font-size: 12px;
          color: #777;
          white-space: nowrap;
        }

        /* Sensor List */
        .sensor-list-container {
          background: var(--light-text);
          border-radius: var(--card-radius);
          padding: 20px;
          box-shadow: var(--card-shadow);
          margin-bottom: 20px;
        }

        .sensor-list-container h3 {
          margin: 0 0 15px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 18px;
          color: var(--primary-color);
        }

        .sensor-list {
          max-height: 300px;
          overflow-y: auto;
          border: 1px solid #eee;
          border-radius: 8px;
          padding: 10px;
        }

        .sensor-item {
          padding: 12px;
          border-bottom: 1px solid #eee;
          display: flex;
          justify-content: space-between;
          align-items: center;
          transition: background 0.2s;
        }

        .sensor-item:hover {
          background: #f9f9f9;
        }

        .sensor-item:last-child {
          border-bottom: none;
        }

        .sensor-info {
          flex: 1;
        }

        .sensor-name {
          font-weight: 600;
          margin-bottom: 4px;
        }

        .sensor-details {
          display: flex;
          gap: 15px;
          font-size: 13px;
          color: #666;
        }

        .sensor-status {
          font-weight: 600;
        }

        .sensor-status.normal { color: var(--normal-color); }
        .sensor-status.atencao { color: var(--attention-color); }
        .sensor-status.alerta { color: var(--warning-color); }
        .sensor-status.critical { color: var(--alert-color); font-weight: bold; }

        .sensor-actions {
          display: flex;
          gap: 8px;
        }

        /* Quick Action Button */
        .quick-action {
          text-align: right;
          margin-bottom: 20px;
        }

        .btn-primary {
          background-color: var(--primary-color);
          color: white;
          border: none;
          padding: 10px 18px;
          border-radius: 6px;
          cursor: pointer;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: background 0.3s;
        }

        .btn-primary:hover {
          background-color: var(--secondary-color);
        }

        .btn-secondary {
          background-color: #6c757d;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          transition: background 0.3s;
        }

        .btn-secondary:hover {
          background-color: #5a6268;
        }

        .btn-danger {
          background-color: var(--alert-color);
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          transition: background 0.3s;
        }

        .btn-danger:hover {
          background-color: #c0392b;
        }

        /* Modal */
        .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 2000;
          justify-content: center;
          align-items: center;
        }

        .modal-content {
          background-color: var(--light-text);
          padding: 25px;
          border-radius: var(--card-radius);
          width: 500px;
          max-width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
          color: var(--primary-color);
          margin: 0;
        }

        .modal-close {
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #777;
          transition: color 0.3s;
        }

        .modal-close:hover {
          color: var(--primary-color);
        }

        .form-group {
          margin-bottom: 18px;
        }

        .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
          width: 100%;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 6px;
          font-size: 14px;
          transition: border 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
          border-color: var(--primary-color);
          outline: none;
        }

        .form-group textarea {
          min-height: 100px;
          resize: vertical;
        }

        .form-actions {
          text-align: right;
          margin-top: 25px;
          display: flex;
          justify-content: flex-end;
          gap: 10px;
        }

        /* Toast Notifications */
        .toast {
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: var(--primary-color);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          animation: slideIn 0.3s ease-out;
          display: flex;
          align-items: center;
          gap: 10px;
        }

        @keyframes slideIn {
          from { transform: translateX(100px); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }

        /* Responsiveness */
        @media (max-width: 1200px) {
          .dashboard-grid {
            grid-template-columns: repeat(2, 1fr);
          }

          .content-grid {
            grid-template-columns: 1fr;
          }
        }

        @media (max-width: 768px) {
          .container {
            flex-direction: column;
          }

          .sidebar {
            width: 100%;
            height: auto;
          }

          .dashboard-grid {
            grid-template-columns: 1fr;
          }

          .content-grid {
            grid-template-columns: 1fr;
          }

          .sensor-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
          }

          .sensor-actions {
            width: 100%;
            justify-content: flex-end;
          }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-tint"></i>
            <span>Monitor Hídrico (2022)</span>
        </div>
        <div class="menu">
            <a href="#" class="active" data-section="dashboard"><i class="fas fa-home"></i> Dashboard</a>
            <a href="#" data-section="sensors"><i class="fas fa-map-marker-alt"></i> Sensores</a>
            <a href="#" data-section="alerts"><i class="fas fa-bell"></i> Alertas</a>
            <a href="#" data-section="reports"><i class="fas fa-chart-bar"></i> Relatórios</a>
            <a href="#" data-section="settings"><i class="fas fa-cog"></i> Configurações</a>
        </div>

    </div>

    <!-- Main Content -->
    <div class="main">
        <div class="header">
            <h1 id="pageTitle">Dashboard de Monitoramento</h1>
            <div class="user-menu">
                <button class="user-menu-btn">
                    <i class="fas fa-user-circle"></i>
                    <span id="adminName">Administrador</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown hidden">
                    <a href="#"><i class="fas fa-user"></i> Meu Perfil</a>
                    <a href="#"><i class="fas fa-cog"></i> Configurações</a>
                    <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</a>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section active">
            <!-- Cards de Estatísticas -->
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-icon normal">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="normalSensors">0</h3>
                        <p>Sensores Normais</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon atencao">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="attentionSensors">0</h3>
                        <p>Sensores em Atenção</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon alerta">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="alertSensors">0</h3>
                        <p>Sensores em Alerta</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon emergencia">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="criticalSensors">0</h3>
                        <p>Sensores Críticos</p>
                    </div>
                </div>
            </div>

            <!-- Grid de Conteúdo Principal -->
            <div class="content-grid">
                <!-- Mapa -->
                <div class="map-container">
                    <h3>Mapa de Sensores</h3>
                    <div id="map"></div>
                </div>

                <!-- Feed de Alertas -->
                <div class="alert-feed">
                    <h3>
                        Feed de Alertas
                        <div class="alert-filters">
                            <select id="alertFilter">
                                <option value="all">Todos</option>
                                <option value="NORMAL">Normal</option>
                                <option value="ATENCAO">Atenção</option>
                                <option value="ALERTA">Alerta</option>
                                <option value="CRITICO">Crítico</option>
                            </select>
                            <button id="addAlertBtn" class="btn-primary">
                                <i class="fas fa-plus"></i> Novo
                            </button>
                        </div>
                    </h3>
                    <div class="alert-list" id="alertList"></div>
                </div>
            </div>
        </div>

        <!-- Sensors Section -->
        <div id="sensorsSection" class="section">
            <div class="quick-action">
                <button id="addSensorBtn" class="btn-primary">
                    <i class="fas fa-plus"></i> Adicionar Sensor
                </button>
                <button id="refreshSensorsBtn" class="btn-secondary" onclick="loadSensors()">
                    <i class="fas fa-refresh"></i> Recarregar Sensores
                </button>
            </div>

            <!-- Lista de Sensores -->
            <div class="sensor-list-container">
                <h3>Sensores do Sistema</h3>
                <div class="sensor-list" id="sensorList"></div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div id="alertsSection" class="section">
            <div class="quick-action">
                <button id="addAlertBtn2" class="btn-primary">
                    <i class="fas fa-plus"></i> Novo Alerta
                </button>
            </div>

            <div class="alert-feed">
                <h3>
                    Feed de Alertas
                    <div class="alert-filters">
                        <select id="alertFilter2">
                            <option value="all">Todos</option>
                            <option value="NORMAL">Normal</option>
                            <option value="ATENCAO">Atenção</option>
                            <option value="ALERTA">Alerta</option>
                            <option value="CRITICO">Crítico</option>
                        </select>
                    </div>
                </h3>
                <div class="alert-list" id="alertList2"></div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reportsSection" class="section">
            <div class="sensor-list-container">
                <h3>Relatórios do Sistema</h3>
                <p>Esta funcionalidade estará disponível em breve. Aqui você poderá gerar relatórios detalhados sobre o desempenho dos sensores e histórico de alertas.</p>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="section">
            <div class="sensor-list-container">
                <h3>Configurações do Sistema</h3>
                <p>Configurações do administrador e preferências do sistema.</p>

                <div class="form-group">
                    <label for="adminNameInput">Nome do Administrador</label>
                    <input type="text" id="adminNameInput" value="Administrador">
                </div>

                <div class="form-group">
                    <label for="systemTheme">Tema do Sistema</label>
                    <select id="systemTheme">
                        <option value="light">Claro</option>
                        <option value="dark">Escuro</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button class="btn-primary" id="saveSettings">Salvar Configurações</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Alerta -->
<div class="modal" id="alertModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Novo Alerta</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="form-group">
            <label for="alertTitle">Título</label>
            <input type="text" id="alertTitle" placeholder="Digite o título do alerta">
        </div>
        <div class="form-group">
            <label for="alertLevel">Nível</label>
            <select id="alertLevel">
                <option value="NORMAL">Normal</option>
                <option value="ATENCAO">Atenção</option>
                <option value="ALERTA">Alerta</option>
                <option value="CRITICO">Crítico</option>
            </select>
        </div>
        <div class="form-group">
            <label for="alertDescription">Descrição (Opcional)</label>
            <textarea id="alertDescription" placeholder="Descreva o alerta com mais detalhes"></textarea>
        </div>
        <div class="form-actions">
            <button class="btn-secondary modal-close">Cancelar</button>
            <button class="btn-primary" id="saveAlert">Salvar</button>
        </div>
    </div>
</div>

<!-- Modal Sensor -->
<div class="modal" id="sensorModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Novo Sensor</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="form-group">
            <label for="sensorName">Nome</label>
            <input type="text" id="sensorName" placeholder="Nome do sensor">
        </div>
        <div class="form-group">
            <label for="sensorLocation">Localização</label>
            <input type="text" id="sensorLocation" placeholder="Localização do sensor">
        </div>
        <div class="form-group">
            <label for="sensorLatitude">Latitude</label>
            <input type="number" id="sensorLatitude" step="any" value="-23.5505">
        </div>
        <div class="form-group">
            <label for="sensorLongitude">Longitude</label>
            <input type="number" id="sensorLongitude" step="any" value="-46.6333">
        </div>
        <div class="form-group">
            <label for="sensorStatus">Status Inicial</label>
            <select id="sensorStatus">
                <option value="NORMAL">Normal</option>
                <option value="ATENCAO">Atenção</option>
                <option value="ALERTA">Alerta</option>
                <option value="CRITICO">Crítico</option>
            </select>
        </div>
        <div class="form-actions">
            <button class="btn-secondary modal-close">Cancelar</button>
            <button class="btn-primary" id="saveSensor">Salvar</button>
        </div>
    </div>
</div>

<script>
    // Variáveis globais
    let sensors = [];
    let alerts = [];
    let map;
    let currentSection = 'dashboard';

    // Função para obter o token de autenticação
    function getAuthToken() {
        const token = localStorage.getItem('mh_token');
        if (!token) {
            throw new Error('Usuário não autenticado');
        }
        return token;
    }

    // Função para fazer requisições autenticadas
    async function makeAuthenticatedRequest(url, options = {}) {
        const token = getAuthToken();

        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        };

        const mergedOptions = {
            ...defaultOptions,
            ...options,
            headers: {
                ...defaultOptions.headers,
                ...options.headers
            }
        };

        const response = await fetch(url, mergedOptions);

        if (response.status === 403) {
            throw new Error('Acesso negado. Faça login novamente.');
        }

        if (response.status === 401) {
            localStorage.removeItem('mh_token');
            localStorage.removeItem('mh_user');
            window.location.href = 'LoginPage.html';
            return;
        }

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || `Erro HTTP: ${response.status}`);
        }

        return response;
    }

    // Função para carregar sensores do backend
    async function loadSensors() {
        try {
            const response = await makeAuthenticatedRequest("http://localhost:8081/api/sensors");
            if (response) {
                sensors = await response.json();
                renderSensorsList();
                updateSensorMap();
                updateStats();
            }
        } catch (error) {
            console.error("Erro ao carregar sensores:", error);
            showToast('Erro ao carregar sensores');
        }
    }

    // Função para alternar status do sensor (Ativar/Desativar)
    async function toggleSensor(id) {
        try {
            const sensor = sensors.find(s => s.id === id);
            if (!sensor) {
                showToast('Sensor não encontrado');
                return;
            }

            const response = await makeAuthenticatedRequest(
                `http://localhost:8081/api/sensors/${id}/ativo`,
                {
                    method: 'POST',
                    body: JSON.stringify({ ativo: !sensor.ativo })
                }
            );

            if (response) {
                const updatedSensor = await response.json();

                // Atualizar o sensor na lista local
                const index = sensors.findIndex(s => s.id === id);
                if (index !== -1) {
                    sensors[index] = updatedSensor;
                }

                renderSensorsList();
                updateSensorMap();
                updateStats();
                showToast(`Sensor ${updatedSensor.ativo ? 'ativado' : 'desativado'} com sucesso!`);
            }
        } catch (error) {
            console.error('Erro ao atualizar sensor:', error);
            showToast(error.message || 'Erro ao atualizar sensor');

            // Se for erro de autenticação, redirecionar para login
            if (error.message.includes('autenticado') || error.message.includes('Acesso negado')) {
                setTimeout(() => {
                    window.location.href = 'LoginPage.html';
                }, 2000);
            }
        }
    }

    // Função para excluir sensor
    async function deleteSensor(id) {
        if (!confirm("Tem certeza que deseja excluir este sensor?")) return;

        try {
            await makeAuthenticatedRequest(
                `http://localhost:8081/api/sensors/${id}`,
                { method: 'DELETE' }
            );

            // Remover da lista local
            sensors = sensors.filter(s => s.id !== id);
            renderSensorsList();
            updateSensorMap();
            updateStats();
            showToast("Sensor excluído com sucesso!");
        } catch (error) {
            console.error('Erro ao excluir sensor:', error);
            showToast(error.message || 'Erro ao excluir sensor');
        }
    }

    // Função para adicionar novo sensor
    async function addNewSensor(sensorData) {
        try {
            const response = await makeAuthenticatedRequest(
                'http://localhost:8081/api/sensors',
                {
                    method: 'POST',
                    body: JSON.stringify(sensorData)
                }
            );

            if (response) {
                const newSensor = await response.json();
                sensors.push(newSensor);
                renderSensorsList();
                updateSensorMap();
                updateStats();
                showToast("Sensor adicionado com sucesso!");
                return newSensor;
            }
        } catch (error) {
            console.error('Erro ao adicionar sensor:', error);
            showToast(error.message || 'Erro ao adicionar sensor');
            return null;
        }
    }

    // Função de debug para verificar autenticação
    async function debugAuth() {
        const token = localStorage.getItem('mh_token');
        const user = JSON.parse(localStorage.getItem('mh_user') || 'null');

        console.log('=== DEBUG AUTH ===');
        console.log('Token:', token ? token.substring(0, 20) + '...' : 'NULL');
        console.log('User:', user);

        if (!token) {
            console.error('❌ Token não encontrado no localStorage');
            return false;
        }

        // Testar uma requisição simples
        try {
            const testResponse = await fetch('http://localhost:8081/api/sensors', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            console.log('Test Request Status:', testResponse.status);
            console.log('Test Request OK:', testResponse.ok);

            if (!testResponse.ok) {
                console.error('❌ Erro na requisição teste:', testResponse.status);
            } else {
                console.log('✅ Requisição teste bem-sucedida');
            }

            return testResponse.ok;
        } catch (error) {
            console.error('❌ Erro na requisição teste:', error);
            return false;
        }
    }

    // Inicialização da página
    document.addEventListener("DOMContentLoaded", async () => {
        // Verificar se o usuário está autenticado
        const token = localStorage.getItem('mh_token');
        const user = JSON.parse(localStorage.getItem('mh_user') || 'null');

        if (!token || !user) {
            alert('Por favor, faça login novamente.');
            window.location.href = 'LoginPage.html';
            return;
        }

        console.log('Usuário autenticado:', user);

        // Atualizar nome do admin no header
        document.getElementById('adminName').textContent = user.nome || 'Administrador';

        // Fazer debug da autenticação
        const authOk = await debugAuth();
        if (!authOk) {
            showToast('Problema de autenticação. Verifique o console.');
        }

        // Carregar dados iniciais
        await loadSensors();
        alerts = [];

        initMap();
        renderSensorsList();
        renderAlerts();
        updateStats();
        setupNavigation();

        // Configurar event listeners
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById("logoutBtn").onclick = () => {
            localStorage.removeItem("mh_token");
            localStorage.removeItem("mh_user");
            window.location.href = "LoginPage.html";
        };

        document.getElementById("addSensorBtn").onclick = () => showModal("sensorModal");
        document.getElementById("addAlertBtn").onclick = () => showModal("alertModal");
        document.getElementById("addAlertBtn2").onclick = () => showModal("alertModal");

        document.querySelectorAll(".modal-close").forEach(btn => {
            btn.onclick = () => btn.closest(".modal").style.display = "none";
        });

        document.getElementById("saveSensor").onclick = async () => {
            const sensorData = {
                sensorId: `SENSOR_${Date.now()}`,
                nome: document.getElementById("sensorName").value,
                localicao: document.getElementById("sensorLocation").value,
                latitude: parseFloat(document.getElementById("sensorLatitude").value),
                longitude: parseFloat(document.getElementById("sensorLongitude").value),
                ativo: true,
                status: document.getElementById("sensorStatus").value
            };

            if (!sensorData.nome) {
                showToast("Nome do sensor é obrigatório!");
                return;
            }

            if (isNaN(sensorData.latitude) || isNaN(sensorData.longitude)) {
                showToast("Latitude e Longitude devem ser números válidos!");
                return;
            }

            await addNewSensor(sensorData);
            hideModal("sensorModal");

            // Limpar formulário
            document.getElementById("sensorName").value = "";
            document.getElementById("sensorLocation").value = "";
            document.getElementById("sensorLatitude").value = "-23.5505";
            document.getElementById("sensorLongitude").value = "-46.6333";
        };

        document.getElementById("saveAlert").onclick = () => {
            const alert = {
                id: Date.now(),
                mensagem: document.getElementById("alertTitle").value || "Alerta",
                descricao: document.getElementById("alertDescription").value || "",
                tipo: document.getElementById("alertLevel").value,
                timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };
            alerts.unshift(alert);
            renderAlerts();
            hideModal("alertModal");
            showToast("Alerta criado com sucesso!");
        };

        document.getElementById("alertFilter").onchange = (e) => {
            renderAlerts(e.target.value);
        };

        document.getElementById("alertFilter2").onchange = (e) => {
            renderAlerts(e.target.value, "alertList2");
        };

        // User menu dropdown
        document.querySelector(".user-menu-btn").onclick = (e) => {
            e.stopPropagation();
            document.querySelector(".dropdown").classList.toggle("hidden");
        };

        document.addEventListener("click", () => {
            document.querySelector(".dropdown").classList.add("hidden");
        });

        // Configurações
        document.getElementById("saveSettings").onclick = () => {
            const adminName = document.getElementById("adminNameInput").value;
            document.getElementById("adminName").textContent = adminName;
            showToast("Configurações salvas com sucesso!");
        };
    }

    function setupNavigation() {
        document.querySelectorAll('.menu a[data-section]').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();

                // Atualizar menu ativo
                document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
                link.classList.add('active');

                // Obter seção alvo
                const sectionId = link.getAttribute('data-section');

                // Atualizar seção ativa
                showSection(sectionId);
            });
        });
    }

    function showSection(sectionId) {
        // Esconder todas as seções
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });

        // Mostrar seção selecionada
        document.getElementById(sectionId + 'Section').classList.add('active');

        // Atualizar título da página
        const titles = {
            dashboard: "Dashboard de Monitoramento",
            sensors: "Gerenciamento de Sensores",
            alerts: "Gerenciamento de Alertas",
            reports: "Relatórios do Sistema",
            settings: "Configurações do Sistema"
        };

        document.getElementById('pageTitle').textContent = titles[sectionId] || "MonitorHídrico";
        currentSection = sectionId;
    }

    function initMap() {
        map = L.map("map").setView([-23.5505, -46.6333], 11);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap"
        }).addTo(map);

        updateSensorMap();
    }

    function updateSensorMap() {
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) map.removeLayer(layer);
        });

        sensors.forEach(s => {
            if (!s.ativo) return;

            let iconColor;
            switch(s.status) {
                case "NORMAL": iconColor = 'green'; break;
                case "ATENCAO": iconColor = 'orange'; break;
                case "ALERTA": iconColor = 'red'; break;
                case "CRITICO": iconColor = 'purple'; break;
                default: iconColor = 'blue';
            }

            const customIcon = L.divIcon({
                html: `<div style="background-color: ${iconColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                className: 'sensor-marker',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            L.marker([s.latitude, s.longitude], {icon: customIcon})
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 8px;">${s.nome}</h4>
                        <p style="margin: 0 0 5px;"><strong>Localização:</strong> ${s.localicao}</p>
                        <p style="margin: 0 0 5px;"><strong>Status:</strong> <span class="sensor-status ${s.status.toLowerCase()}">${s.status}</span></p>
                        <p style="margin: 0;"><strong>Coordenadas:</strong> ${s.latitude.toFixed(4)}, ${s.longitude.toFixed(4)}</p>
                    </div>
                `);
        });
    }

    function renderSensorsList() {
        const list = document.getElementById("sensorList");
        if (!list) return;

        list.innerHTML = "";

        sensors.forEach(s => {
            const statusText = s.ativo ? "Ativo" : "Inativo";
            const statusClass = s.ativo ?
                `sensor-status ${s.status.toLowerCase()}` :
                "sensor-status critical";

            const item = document.createElement("div");
            item.className = "sensor-item";
            item.innerHTML = `
                <div class="sensor-info">
                    <div class="sensor-name">${s.nome}</div>
                    <div class="sensor-details">
                        <span>${s.localicao || "Sem localização"}</span>
                        <span>${s.latitude ? s.latitude.toFixed(4) : 'N/A'}, ${s.longitude ? s.longitude.toFixed(4) : 'N/A'}</span>
                        <span class="${statusClass}">${statusText} - ${s.status}</span>
                    </div>
                </div>
                <div class="sensor-actions">
                    <button class="${s.ativo ? 'btn-secondary' : 'btn-primary'}" onclick="toggleSensor(${s.id})">
                        ${s.ativo ? 'Desativar' : 'Ativar'}
                    </button>
                    <button class="btn-danger" onclick="deleteSensor(${s.id})">Excluir</button>
                </div>
            `;
            list.appendChild(item);
        });
    }

    function renderAlerts(filter = "all", listId = "alertList") {
        const list = document.getElementById(listId);
        if (!list) return;

        list.innerHTML = "";

        const filteredAlerts = filter === "all" ? alerts : alerts.filter(a => a.tipo === filter);

        filteredAlerts.forEach(a => {
            const item = document.createElement("div");
            item.className = "alert-item";
            item.innerHTML = `
                <div class="alert-icon ${a.tipo.toLowerCase()}"></div>
                <div class="alert-content">
                    <div>${a.mensagem}</div>
                    ${a.descricao ? `<div style="font-size: 12px; color: #777; margin-top: 4px;">${a.descricao}</div>` : ''}
                </div>
                <div class="alert-time">${a.timestamp}</div>
            `;
            list.appendChild(item);
        });
    }

    function updateStats() {
        const normal = sensors.filter(s => s.status === "NORMAL" && s.ativo).length;
        const atencao = sensors.filter(s => s.status === "ATENCAO" && s.ativo).length;
        const alerta = sensors.filter(s => s.status === "ALERTA" && s.ativo).length;
        const critico = sensors.filter(s => s.status === "CRITICO" && s.ativo).length;

        document.getElementById("normalSensors").textContent = normal;
        document.getElementById("attentionSensors").textContent = atencao;
        document.getElementById("alertSensors").textContent = alerta;
        document.getElementById("criticalSensors").textContent = critico;
    }

    function showModal(modalId) {
        document.getElementById(modalId).style.display = "flex";
    }

    function hideModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }

    function showToast(message) {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // Disponibilizar funções globalmente para debug
    window.debugAuth = debugAuth;
    window.loadSensors = loadSensors;
</script>
</body>
</html>